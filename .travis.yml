language: java
jdk: openjdk6
branches:
  only: command
env:
  global:
  # $KEY
  - secure: "L+xoBZ3nA8i/n8zEA6PuNJSXeuKUs+1VpQEycj7bUzvays4GMhwfokjEpn6e0uwpCvmUvc9JG9kLQuIhK8yoHex9Qwh07nh2cxQT20KTJs+DjodBTDwz6vVsilNgka7XKx0QLR2eojvnAhbRJdu8T/eNUJMZgaO8vpUfeQZpHvM="
  # $KEOLIS_API_KEY
  - secure: "K1W2JHG2uIhRGc9Kr5OjfCyA6DFflrZkj45yMoc8NuFoMMNyS8Z9or69Zi6J6z+q8QYmZzcq3c6mSNaiK/BHMulqIWfRoOAbKSg/S/3ZhaDMSwKbHDWjvAumw62vtdj9PK7woBtaaX+Y63Bwd70i1tmAp1V6gvkt2Oq7TGfWPxk="

before_install:
- source params.sh
- sudo apt-get update -qq
- sudo apt-get install imagemagick inkscape -qq

before_script:
# setup git
- git config --global user.email "jeremie+travis+itinerennes+data+bundle+generator@dudie.fr"
- git config --global user.name "Travis CI"

# install Travis tools
- git clone https://gist.github.com/7630453.git travis-tools

# register Github identity
- curl "https://raw.github.com/dudie/maven-repository/master/github_key.pub" >> ~/.ssh/known_hosts
#- cat travis-tools/id_github.pub > ~/.ssh/known_hosts
- cat ~/.ssh/known_hosts

# setup private key for deployment
- cat id_itinerennes-data-bundle-generator.enc | ./travis-tools/decrypt.sh $KEY > id_itinerennes-data-bundle-generator
- chmod 400 id_itinerennes-data-bundle-generator
- eval $(ssh-agent)
- ssh-add id_itinerennes-data-bundle-generator

# export GTFS file identifier
- export GTFS_ID=$(basename $GTFS_URL)

# download GTFS data bundle
- wget $GTFS_URL -O GTFS.zip

# download keois Keolis icons
- wget $IMAGES_URL -O keolis-icons.zip
- mkdir -p keolis-icons/original keolis-icons/resized
- unzip keolis-icons.zip -d keolis-icons/original

# download itinerennes data bundle generator
#- mvn dependency:get -Dartifact=fr.itinerennes:itinerennes-data-bundle-generator:1.0:tar.bz2:dist-pkg -DremoteRepositories=https://raw.github.com/dudie/maven-repository/releases
#- mvn dependency:copy -Dartifact=fr.itinerennes:itinerennes-data-bundle-generator:1.0:tar.bz2:dist-pkg -D outputDirectory=. -Dmdep.stripClassifier -Dmdep.stripVersion
- wget -O itinerennes-data-bundle-generator.tar.bz2 https://raw.github.com/dudie/maven-repository/releases/fr/itinerennes/itinerennes-data-bundle-generator/1.2/itinerennes-data-bundle-generator-1.2-dist-pkg.tar.bz2
- tar jxf itinerennes-data-bundle-generator.tar.bz2

# initialize itinerennes-api repository with new branch
- git clone -b data git@github.com:dudie/itinerennes-api.git itinerennes-api
- cd itinerennes-api
- git checkout -b $GTFS_RELEASE
- git rm -r ./* > /tmp/commit.log
- head -10 /tmp/commit.log && tail -10 /tmp/commit.log
- echo "GTFS $GTFS_RELEASE" > README.md
- echo "=============" >> README.md
- echo "$GTFS_URL" >> README.md
- git add README.md
- cd -

# initialize a new branch in itinerennes-android repository
- git clone git@github.com:dudie/itinerennes-android.git itinerennes-android
- cd itinerennes-android
- git checkout keolis-res-update || git checkout -b keolis-res-update
- cd -

script:
# generate API results
- ./itinerennes-data-bundle-generator/bundler.sh GTFS.zip -am 1=2 -k $KEOLIS_API_KEY -o itinerennes-api
- ls -la itinerennes-api
- cd itinerennes-api
- git add .
- git commit -m "Add data from $GTFS_ID" > commit.log
- head -50 commit.log && tail -50 commit.log
- git push origin $GTFS_RELEASE
- cd -
# generate APK resources
- mkdir -p keolis-icons/original keolis-icons/resized
- ./itinerennes-data-bundle-generator/gen-keolis-icons.sh keolis-icons/original keolis-icons/resized
- cp keolis-icons/resized/*.png itinerennes-android/itinerennes/res/drawable
- cp itinerennes-api/markers.csv itinerennes-api/routes_stops.csv itinerennes-api/routes.csv itinerennes-android/itinerennes/res/raw
- cd itinerennes-android
- git add .
- git commit -m "Update CSV data with $GTFS_ID"
- git push origin keolis-res-update
- cd -
